name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        env:
          NODE_ENV: test
          MONGO_URI: mongodb://localhost:27017/test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret
          JWT_REFRESH_SECRET: test-refresh-secret
          STRIPE_SECRET_KEY: sk_test_dummy
          STRIPE_WEBHOOK_SECRET: whsec_dummy
          RAZORPAY_KEY_ID: rzp_test_dummy
          RAZORPAY_KEY_SECRET: rzp_secret_dummy
          RAZORPAY_WEBHOOK_SECRET: rzp_wh_dummy
        run: npm test
      - name: Security audit
        run: npm audit --audit-level=high || true

  prod-gate:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Start MongoDB for gate
        run: |
          docker run -d --name prod-gate-mongo -p 27017:27017 mongo:6
      - name: Run production gate
        env:
          NODE_ENV: production
          PORT: 3000
          MONGO_URI: mongodb://127.0.0.1:27017/prod-gate
          JWT_SECRET: test-secret
          JWT_EXPIRES_IN: 1h
          JWT_REFRESH_SECRET: test-refresh-secret
          JWT_REFRESH_EXPIRES_IN: 7d
          SMTP_HOST: localhost
          SMTP_PORT: 1025
          SMTP_USER: test
          SMTP_PASS: test
          STRIPE_SECRET_KEY: sk_test_dummy
          RAZORPAY_KEY_ID: rzp_test_dummy
          RAZORPAY_KEY_SECRET: rzp_secret_dummy
        run: |
          chmod +x scripts/prod-gate.sh
          scripts/prod-gate.sh
      - name: Cleanup gate services
        if: always()
        run: |
          docker rm -f prod-gate-mongo || true
